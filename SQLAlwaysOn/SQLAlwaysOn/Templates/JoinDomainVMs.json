{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "apiVersion": {
      "type": "string",
      "metadata": {
        "description": "Schema api version from parent template"
      }
    },
    "domainToJoin": {
      "type": "string"
    },
    "domainUsername": {
      "type": "string"
    },
    "domainPassword": {
      "type": "securestring"
    },
    "arrVMName": {
      "type": "string"
    },
    "iisVMName": {
      "type": "string"
    },
    "mmqVMName": {
      "type": "string"
    },
    "appVMName": {
      "type": "string"
    },
    "rspVMName": {
      "type": "string"
    },
    "tskVMName": {
      "type": "string"
    },
    "admVMName": {
      "type": "string"
    }
  },
  "variables": {
    "domainJoinOptions": "3",
    "ouPath": ""
  },
  "resources": [
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('arrVMName'),'1/joinDomain')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('arrVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('arrVMName'),'1/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('iisVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('arrVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('arrVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('iisVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('iisVMName'),'1/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('mmqVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('iisVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('iisVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('mmqVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('mmqVMName'),'1/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('appVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('mmqVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('mmqVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('appVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('appVMName'),'1/extensions/joinDomain')]",
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('rspVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('appVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('appVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('rspVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('rspVMName'),'1/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('tskVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('rspVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('rspVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('tskVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('tskVMName'),'1/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('admVMName'),'1/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('tskVMName'),'1/extensions/joinDomain')]",
        "[concat('Microsoft.Compute/virtualMachines/',parameters('tskVMName'),'2/extensions/joinDomain')]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    },
    {
      "apiVersion": "[parameters('apiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('admVMName'),'2/joinDomain')]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/',parameters('admVMName'),'1/extensions/joinDomain')]",
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.0",
        "settings": {
          "Name": "[parameters('domainToJoin')]",
          "OUPath": "[variables('ouPath')]",
          "User": "[concat(parameters('domainToJoin'),'\\',parameters('domainUsername'))]",
          "Restart": "true",
          "Options": "[variables('domainJoinOptions')]"
        },
        "protectedsettings": {
          "Password": "[parameters('domainPassword')]"
        }
      }
    }
  ],
  "outputs": {
    "result": {
      "value": "Join Domain achieved",
      "type": "string"
    }
  }
}
